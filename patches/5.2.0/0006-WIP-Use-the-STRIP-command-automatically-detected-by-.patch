From 225e10c01dda9bf848e13a3bc938adc911cda510 Mon Sep 17 00:00:00 2001
From: Samuel Hym <samuel.hym@rustyne.lautre.net>
Date: Fri, 23 Feb 2024 12:00:32 +0100
Subject: [PATCH 06/14] WIP Use the STRIP command automatically detected by
 libtool

libtool configuration will try and detect the `strip` for the code
generated by the configured C compiler, so that it works also for a
cross-compiler

WIP: ensure it works also on MSVC, hopefully libtool-detected strip will
not break the compiled code
---
 Makefile.config.in |   1 +
 configure          | Bin 682312 -> 682313 bytes
 configure.ac       |   1 +
 stdlib/Makefile    |   5 +----
 4 files changed, 3 insertions(+), 4 deletions(-)

diff --git a/Makefile.config.in b/Makefile.config.in
index 4243bebad9..b91634efb6 100644
--- a/Makefile.config.in
+++ b/Makefile.config.in
@@ -185,6 +185,7 @@ OCAMLOPT_CFLAGS=@ocamlc_cflags@
 OCAMLOPT_CPPFLAGS=@ocamlc_cppflags@
 NATIVECCLIBS=@cclibs@
 SYSTHREAD_SUPPORT=@systhread_support@
+STRIP=@STRIP@
 PACKLD=@PACKLD@$(EMPTY)
 CCOMPTYPE=@ccomptype@
 TOOLCHAIN=@toolchain@
diff --git a/configure b/configure
index af81d82dbaae033e150d880621d16a2082d15600..157020657d0e6ba1b768c7e958d2a8f2ae5be2aa 100755
GIT binary patch
delta 67
zcmX?cN%Q0-%?)|}n@jvxGqMJU1bGHD%LQ(i3uOGQ)-F-O2*gZ4%nZaVK+FonY(UHo
N#2nitDmV>30svuD7c~F?

delta 67
zcmX?kN%O=d%?)|}tid5co&lS4{ns!y%Li_k4`lqM)-F}S2*gZ4%nZaVK+FonY(UHo
N#2nkDDme8&0svg|7eN33

diff --git a/configure.ac b/configure.ac
index 6d4025dc55..342db956bc 100644
--- a/configure.ac
+++ b/configure.ac
@@ -243,6 +243,7 @@ AC_SUBST([mkdll_ldflags_exp])
 AC_SUBST([mkexe_ldflags_exp])
 AC_SUBST([PACKLD])
 AC_SUBST([build_libraries_manpages])
+AC_SUBST([STRIP])
 AC_SUBST([compute_deps])
 AC_SUBST([ocaml_bindir])
 AC_SUBST([ocaml_libdir])
diff --git a/stdlib/Makefile b/stdlib/Makefile
index 50f825a1b3..a7f2e60a7a 100644
--- a/stdlib/Makefile
+++ b/stdlib/Makefile
@@ -96,10 +96,7 @@ endif
 .INTERMEDIATE: tmpheader.exe
 tmpheader.exe: $(HEADERPROGRAM).$(O)
 	$(V_MKEXE)$(call MKEXE_VIA_CC,$@,$^)
-# FIXME This is wrong - mingw could invoke strip; MSVC equivalent?
-ifneq "$(UNIX_OR_WIN32)" "win32"
-	strip $@
-endif
+	$(STRIP) $@
 
 stdlib.cma: $(OBJS)
 	$(V_LINKC)$(CAMLC) -a -o $@ $^
-- 
2.45.1

